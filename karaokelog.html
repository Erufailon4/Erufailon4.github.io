<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>karaoke log</title>
	<style type="text/css">
		tr {
			border-bottom: 1px solid gray;
		}
	</style>
</head>
<body>
	<!-- COPIED FROM HNTA WEBSITE -->
	<p style="font-weight: bold;">Search our karaoke songs and select a song: </p>
<div style="display: grid; grid-template-columns: max-content auto; grid-gap: 10px; margin-bottom: 1.2em;">
   <div>Artist:</div><div><input type="text" name="artist" id="artistsearch" style="border-style: solid; width: 100%;" /></div>
   <div>Song:</div><div><input type="text" name="song" id="songsearch" style="border-style: solid; width: 100%;" /></div>
   <div>Anime:</div><div><input type="text" name="anime" id="animesearch" style="border-style: solid; width: 100%;" /></div>
   <div> </div><div><button type="button" onclick="karaokeSearch()" style="width: 100%;">Search</button></div>
</div>
	<!-- END COPY -->
	<p><button type="button" onclick="listData()">List all data</button></p>
	<div id="songtable"></div>
	<p><i>Selected song:</i> <span id="selectedsong">none</span> <span id="selectedlastsung"></span></p>
	<p style="font-weight: bold;">Update the selected song: </p>
	<p>The date the song was sung: <input type="date" id="sungdate" /> <button type="button" onclick="updateData()">Update</button></p>
	<p style="font-weight: bold;">Save data as a file: </p>
    <p><button type="button" onclick="saveFile()">Save</button></p>
	<p style="font-weight: bold;">Load data from a file: </p>
	<p><input type="file" id="fileinput" accept=".json,application/json" /></p>
	<p><button type="button" onclick="loadFile()">Load</button></p>
<script type="text/javascript">
var selectedartist = "testartist";
var selectedtitle = "testtitle";
var logdata = [];
/*
The data is an array of objects, each containing the (tokenized) artist and title of the song and the date it was last sung.
*/

function containsSong(arr,artval,titval) {
	return arr.findIndex((arrVal) => arrVal.artist==artval && arrVal.title==titval);
}
function sortSonglist(a,b) {
	let foundindex = containsSong(logdata,tokenizeStr(a.artist),tokenizeStr(a.title));
	let alastsung = "1999-12-31";
	if (foundindex != -1) {
		alastsung = logdata.at(foundindex).lastsung;
	}
	foundindex = containsSong(logdata,tokenizeStr(b.artist),tokenizeStr(b.title));
	let blastsung = "1999-12-31";
	if (foundindex != -1) {
		blastsung = logdata.at(foundindex).lastsung;
	}
	// this is a precaution in case a song ends up in logdate with an empty date
	if (alastsung == "" && blastsung != "") {return -1;}
	if (alastsung != "" && blastsung == "") {return 1;}
	const datea = new Date(alastsung);
	const dateb = new Date(blastsung);
	if (datea < dateb) {return -1;} 
	else if (datea > dateb) {return 1;}
	else if (a.anime < b.anime) {return -1;}
	else if (a.anime > b.anime) {return 1;}
	else {return 0;}
}

// COPIED FROM HNTA WEBSITE (WITH MODIFICATIONS TO OUTPUTTABLE AND KARAOKESEARCH)
function tokenizeStr(inputstr) {
    return inputstr.toLowerCase().replaceAll(/[\x27?!:-\s]/g,"");
}
async function scrapeGoogle() {
	let res = await fetch("https://docs.google.com/spreadsheets/u/0/d/e/2PACX-1vTFHxMlqkQW-aVmnz8IcB1w6glfoY0WNsu-EtIlCPBNzEK38UfJAwWJGHAmQErX9zcQdwL8XLyrr7FI/pub?output=tsv&range=B1:D");
	let html = await res.text();
	let row_data = html
  .split("\n")
  .map(row =>  
    row
      .split("\t")
      .map(elem => elem.trim())
	);
	let data = row_data.slice(1).map(row => {
  let obj = {artist: row[0], title: row[1], anime: row[2]};
  return obj;
	});
	return data;
}
var songlist;
(async () => {
	songlist = await scrapeGoogle();
	console.log("karaoke list parsed, songs:");
	console.log(songlist.length);
})()
function outputTable(songlist) {
    let tablehtml = '<table class="table"><thead><tr><th scope="col"> </th><th scope="col">Artist</th><th scope="col">Song</th><th scope="col">Anime</th><th scope="col">Last sung</th></tr></thead><tbody>';
	const sortedlist = songlist.toSorted(sortSonglist);
    for (let song of sortedlist) {
		tablehtml += '<tr><td><button type="button" onclick="selectSong(\''+tokenizeStr(song.artist)+'\',\''+tokenizeStr(song.title)+'\')">Select</button></td>';
        tablehtml += '<td>'+song.artist+'</td><td>'+song.title+'</td><td>'+song.anime+'</td>';
		// last sung date for the row
		const foundindex = containsSong(logdata,tokenizeStr(song.artist),tokenizeStr(song.title));
		let lastsungstr = "";
		if (foundindex != -1) {
			lastsungstr = logdata.at(foundindex).lastsung;
		} else {
			lastsungstr = " ";
		}
		tablehtml += '<td>'+lastsungstr+'</td></tr>'
    }
    tablehtml += '</tbody></table>';
    return tablehtml;
}
function karaokeSearch() {
    const artistsearchinput = tokenizeStr(document.getElementById("artistsearch").value);
    const songsearchinput = tokenizeStr(document.getElementById("songsearch").value);
    const animesearchinput = tokenizeStr(document.getElementById("animesearch").value);
    //console.log(searchinput);

    const newsonglist = [];
    for (let song of songlist) {
        if ((artistsearchinput != "" && tokenizeStr(song.artist).includes(artistsearchinput)) 
            || (songsearchinput != "" && tokenizeStr(song.title).includes(songsearchinput)) 
            || (animesearchinput != "" && tokenizeStr(song.anime).includes(animesearchinput))) {
                newsonglist.push(song);
            }
    }
    document.getElementById("songtable").innerHTML = outputTable(newsonglist);
    //randombutton.style.display = "none";
}
// END COPY

function listData() {
	const newsonglist = [];
	for (let song of songlist) {
		if (containsSong(logdata,tokenizeStr(song.artist),tokenizeStr(song.title)) != -1) {
			newsonglist.push(song);
		}
	}
	document.getElementById("songtable").innerHTML = outputTable(newsonglist);
}

function refreshLastSung() {
	const foundindex = containsSong(logdata,selectedartist,selectedtitle);
	let lastsungstr = "";
	if (foundindex != -1) {
		lastsungstr = logdata.at(foundindex).lastsung;
	} else {
		lastsungstr = "never";
	}
	document.getElementById("selectedlastsung").innerHTML = "(last sung: "+lastsungstr+")";
}
function selectSong(artist,title) {
	selectedartist = artist;
	selectedtitle = title;
	document.getElementById("selectedsong").innerHTML = selectedartist+" - "+selectedtitle;
	refreshLastSung();
}
function updateData() {
	const sungdate = document.getElementById("sungdate").value;
	const foundindex = containsSong(logdata,selectedartist,selectedtitle);
	if (foundindex != -1) {
		logdata.at(foundindex).lastsung = sungdate;
	} else {
		const logentry = {artist: selectedartist, title: selectedtitle, lastsung: sungdate};
		logdata.push(logentry);
	}
	refreshLastSung();
}

function loadFileActual() {
	const fileInput = document.getElementById("fileinput");
    const [file] = fileInput.files;
	if (file) {
		file.text().then(function(data) {
			logdata = JSON.parse(data);
		})
	}
}

function loadFile() {
	if (logdata.length > 0) {
		if (window.confirm("Data already exists, do you REALLY want to load and overwrite?")) {
			loadFileActual();
		}
	} else {
		loadFileActual();
	}
}

function saveFile() {
    const filecontents = [JSON.stringify(logdata)];
    const fileBlob = new Blob(filecontents, { type: "application/json" });
    const fileurl = URL.createObjectURL(fileBlob);
    const link = document.createElement('a');
    link.href = fileurl;
    link.download = 'karaokelog.json';
    document.body.appendChild(link);
    link.click();
    // Clean up
    document.body.removeChild(link);
    URL.revokeObjectURL(fileurl);

  /*// create a new handle
  const newHandle = await window.showOpenFilePicker();

  // create a FileSystemWritableFileStream to write to
  const writableStream = await newHandle.createWritable();

  // write our file
  const filecontents = ["This is a test."];
  const fileBlob = new Blob(filecontents, { type: "text/plain" });
  await writableStream.write(fileBlob);

  // close the file and write the contents to disk.
  await writableStream.close();*/
}
</script>
</body>
</html>
